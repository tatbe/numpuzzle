<!DOCTYPE html>
<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
</head>
<body>
        <canvas id="myCanvas" width="500" height="500"></canvas>
        <div>d:<span id="damageNum">0</span></div>
        <button id="start">start</button>

</body>
<style></style>
<script type="text/javascript">
    window.addEventListener("load", init);
    var stage;
    var gameStatus;
    let handleDown = (e) => {
        console.log(e);
        createjs.Tween.removeTweens(e.target);
    }
    let handleMove = (e) => {
        e.target.x = e.rawX;
        e.target.y = e.rawY;
    } 
    let handleUp = (e) => {
        console.log(e);
        let children = stage.children;
        let removeObj = [];
        let count = 0;
        $.each(children, function(i, obj) {
            if (obj.x -25 <= e.target.x && e.target.x <= obj.x +25
                && obj.y -25 <= e.target.y && e.target.y <= obj.y +25
             ) {
                count++;
                removeObj.push(obj);
            }
            if (count > 1) {
                stage.removeChild(removeObj[0]);
                stage.removeChild(removeObj[1]);
                return false;
            }
        });
        if (count <= 1) {
            createjs.Tween.get(e.target) // ターゲットを指定
                .to({y: 525}, 10000);
        }

        
    }

    let checkNum = () => {
        let children = stage.children;
        $.each(children, function(i, obj) {
            if (obj && obj.y >= 500 + 25) {
                stage.removeChild(obj);
                gameStatus.damage++;
            }
        });
        $("#damageNum").text(gameStatus.damage);
    }

    let createNum = (opt) => {
        // 円のシェイプを作成
        var bmp = new createjs.Bitmap("./numblock_5.png");
        bmp.x = opt.position*100+25;
        bmp.regX = 25;
        bmp.regY = 25;
        stage.addChild(bmp);

        createjs.Tween.get(bmp) // ターゲットを指定
                .to({y: 525}, 10000);
        // ステージを更新する
        createjs.Ticker.timingMode = createjs.Ticker.RAF;
        createjs.Ticker.addEventListener("tick", handleTick);
        function handleTick() {
            checkNum();
            stage.update();
        }

        bmp.addEventListener("mousedown", handleDown);
        bmp.addEventListener("pressmove", handleMove);
        bmp.addEventListener("pressup", handleUp);
    }

    let play = () => {
        setInterval(() => {
            var opt = {};
            opt.position = Math.floor( Math.random() * 5 );
            createNum(opt)
        }, 2000);
    }

    function init() {
        stage = new createjs.Stage("myCanvas");
        gameStatus = {
            damage: 0
        };
        $("#start").click(() => {
            play();
        })
        //createNum();
    }

</script>
</html>