<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
</head>
<body>
        <canvas id="myCanvas" width="500" height="500"></canvas>
        <div>point:<span id="pointNum">0</span></div>
        <div>miss:<span id="missNum">0</span></div>
        <div><span id="status"></span></div>
        <button id="start">start</button>

</body>
<style></style>
<script type="text/javascript">
    window.addEventListener("load", init);
    var stage;
    var gameStatus;
    var interval_1;
    var interval_2;

    let handleResize = () => {
        var w = window.innerWidth;
        stage.canvas.width = w;
        stage.canvas.height = w;
    }

    let handleDown = (e) => {
        console.log(e);
        createjs.Tween.removeTweens(e.currentTarget);
        stage.setChildIndex(e.target,(stage.getNumChildren())-1);
    }
    let handleMove = (e) => {
        e.currentTarget.x = e.rawX;
        e.currentTarget.y = e.rawY;
    } 
    let handleUp = (e) => {
        console.log(e);
        let children = stage.children;
        let removeObj = [];
        let count = 0;
        $.each(children, function(i, obj) {
            if (obj.x -25 <= e.currentTarget.x && e.currentTarget.x <= obj.x +25
                && obj.y -25 <= e.currentTarget.y && e.currentTarget.y <= obj.y +25
             ) {
                count++;
                removeObj.push(obj);
            }
            if (count > 1 && removeObj[0].children[1].text + removeObj[1].children[1].text == 10) {
                stage.removeChild(removeObj[0]);
                stage.removeChild(removeObj[1]);
                gameStatus.point++;
                $('#pointNum').text(gameStatus.point);
                return false;
            } else if (count > 1 && removeObj[0].children[1].text + removeObj[1].children[1].text > 10) {
                count = 0
                return false;
            } else if (count > 1) {
                removeObj[1].children[1].text = removeObj[0].children[1].text + removeObj[1].children[1].text
                stage.removeChild(removeObj[0]);
                count = 0
                return false;
            }
        });
        if (count <= 1) {
            let range = stage.canvas.height;
            createjs.Tween.get(e.currentTarget) // ターゲットを指定
                .to({y: range + e.currentTarget.regY}, 5000 / (range + e.currentTarget.regY) * (range + e.currentTarget.regY - e.currentTarget.y));
        }

        
    }

    let checkNum = () => {
        let children = stage.children;
        let range = stage.canvas.height;
        $.each(children, function(i, obj) {
            if (obj && obj.y >= range + obj.regY) { // TODO:regYが０になってる
                createjs.Tween.removeTweens(obj);
                stage.removeChild(obj);
                gameStatus.miss++;
            }
        });
        $("#missNum").text(gameStatus.miss);
        if (gameStatus.miss >= 5) {
            createjs.Ticker.paused = true;
            clearInterval(interval_1);
            clearInterval(interval_2);
            $('#status').text('GAME OVER');
        }
    }

    let createNum = (opt) => {
        let cont = new createjs.Container();
        stage.addChild(cont);
        stage.setChildIndex(cont, 0);

        let w = stage.canvas.width;
        // 円オブジェクトの半径算出
        let radius = w / 15;
        cont.x = opt.position * w / 5 + radius;

        // 円オブジェクト
        let shape = new createjs.Shape();
        shape.graphics.beginFill("#eeeeee");// 色
        shape.graphics.beginStroke("#eeeeee");// 線の色
        shape.graphics.setStrokeStyle(2);// 線の幅
        shape.graphics.drawCircle(0, 0, radius);//半径 50px の円を描画
        cont.addChild(shape);

        // 数字決定
        let numRand = Math.floor( Math.random() * 20);
        let numArr = [1,1,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6];

        // テキスト
        let text = new createjs.Text(numArr[numRand], "25px serif", "#999999");
        text.textAlign = "center";
        text.textBaseline = "middle";
        cont.addChild(text);

        let range = stage.canvas.height;
        createjs.Tween.get(cont) // ターゲットを指定
                .to({y: range + cont.regY}, 10000);
        // ステージを更新する
        createjs.Ticker.timingMode = createjs.Ticker.RAF;
        createjs.Ticker.addEventListener("tick", handleTick);
        function handleTick() {
            checkNum();
            stage.update();
        }

        cont.addEventListener("mousedown", handleDown);
        cont.addEventListener("pressmove", handleMove);
        cont.addEventListener("pressup", handleUp);
    }

    let play = () => {
        let count = 0;
        // interval = setInterval(() => {
            // var speed = 2000;

            // if (count >= 8 && count <= 16) {
            //     speed = 1500;
            // } else if (count >= 17 && count <= 32) {
            //     speed = 1000;
            // }

            // gameStatus.speed = speed;
            

        // }, 2000);

        count++;
        interval_2 = setInterval(() => {
            let opt = {};
            opt.position = Math.floor( Math.random() * 5 );
            createNum(opt);
        }, 2000);
        interval_1 = setInterval(() => {
            if (count == 1) {
                count++;
                clearInterval(interval_2);
                interval_2 = setInterval(() => {
                    let opt = {};
                    opt.position = Math.floor( Math.random() * 5 );
                    createNum(opt);
                }, 1700);
            } else if (count == 2) {
                count++;
                clearInterval(interval_2);
                interval_2 = setInterval(() => {
                    let opt = {};
                    opt.position = Math.floor( Math.random() * 5 );
                    createNum(opt);
                }, 1200);
            }
        }, 10000);
    }

    function init() {
        stage = new createjs.Stage("myCanvas");
        // タッチ操作をサポートしているブラウザーならば
        if (createjs.Touch.isSupported() == true) {
            // タッチ操作を有効にします。
            createjs.Touch.enable(stage);
        }
        handleResize();
        gameStatus = {
            point: 0,
            miss: 0,
            speed: 2000
        };
        $("#start").click(() => {
            play();
        })
        //createNum();
    }

</script>
</html>